```markdown
# Minion Management Features: Design Document

## 1. Introduction

This document outlines the design for minion management features within Steven's AI Minion Army. These features include naming, renaming, and dynamically creating new minions post-initial deployment. The goal is to provide Steven (the user) with intuitive control over his minion legion via the Management GUI.

The core principle is that each minion has a **unique, immutable `minion_id`** (typically a UUID or a config-defined string like "Alpha", "Bravo") used for all internal system operations, A2A communication addressing, and logging. A **user-facing `minion_name`** will serve as a mutable alias for easier identification and management in the GUI.

## 2. Requirements for Minion Management

### 2.1. Naming

*   **Initial Naming:**
    *   **Source:** Minions are initially "named" based on their `minion_id` as defined in the `minion_spawner.minions` section of the `config.toml` file (e.g., "Alpha", "Bravo"). This `minion_id` is passed to the [`minion_core/main_minion.py`](minion_core/main_minion.py) script during spawning.
    *   The `agent_card` generated in [`minion_core/main_minion.py`](minion_core/main_minion.py:100-112) uses a format like `f"Minion {self.minion_id} ({self.personality_traits.split(',')[0].strip()})"` for its `name` field. This will be adapted to incorporate the user-facing `minion_name`.
    *   **Proposal:** Introduce a new optional `name` field within each minion's definition in `config.toml` under `minion_spawner.minions`.
        ```toml
        [[minion_spawner.minions]]
        id = "minion_uuid_1"
        name = "StrategistPrime" # User-defined initial name
        personality = "Analytical, Calm, Decisive"
        # ... other params
        ```
    *   If the `name` field is absent, the system will default to using the `minion_id` as the initial `minion_name`.
*   **Storage and Reference:**
    *   The `minion_id` remains the primary key.
    *   The `minion_name` will be stored as part of the minion's state/configuration, potentially within the A2A server's agent registry alongside the `agent_card`. The `agent_card` itself should be updated to include this user-facing `minion_name` distinctly from the `minion_id`.
    *   The Management GUI ([`management_gui/gui_app.py`](management_gui/gui_app.py)) will fetch and display this `minion_name`.

### 2.2. Renaming

*   **User Interaction (GUI):**
    *   Steven will be able to select a minion in the Management GUI.
    *   An "Edit" or "Rename" button/option will be available for each minion.
    *   Clicking this will open a dialog or inline input field where Steven can enter a new `minion_name`.
*   **Implications of Renaming:**
    *   **A2A Server Registration:** The `minion_name` in the A2A server's agent registry must be updated. The `agent_card` stored by the server should reflect the new name.
    *   **GUI Display:** The Management GUI must refresh to show the new name.
    *   **Logs:** Logs should primarily reference `minion_id`. If `minion_name` is logged for readability, it should be clear that this name can change. Consider logging events like "Minion ID 'xyz' renamed from 'OldName' to 'NewName'".
    *   **Ongoing Tasks:** Renaming should not affect ongoing tasks as they should be tracked by `minion_id`.
    *   **M2M Communications:** Minion-to-Minion (M2M) communication must use `minion_id` for addressing, so renaming the user-facing `minion_name` will have no impact.
*   **Restrictions on Renaming:**
    *   **Name Uniqueness:** The new `minion_name` should ideally be unique among active minions to avoid confusion in the GUI. The system should provide a warning if a duplicate name is attempted, but could allow it if `minion_id` is always displayed alongside. For simplicity, initially enforce unique names.
    *   **Active Task Processing:** Renaming should generally be permissible even if the minion is active, as the `minion_id` is the stable identifier. No specific restrictions are needed initially.

### 2.3. Creating New Minions (Dynamic Spawning)

*   **User Initiation (GUI):**
    *   Steven will have a "Create New Minion" or "Spawn Minion" button in the Management GUI.
    *   Clicking this will open a dialog/form to configure the new minion.
*   **Configurable Parameters:**
    *   **`minion_name` (User-defined):** Required. This will be the user-facing alias.
    *   **`minion_id` (Auto-generated):** A new unique `minion_id` (e.g., UUID) will be generated by the system upon creation request. This ensures uniqueness and avoids collisions.
    *   **Personality Traits:** User can select from predefined traits or enter a custom string.
    *   **Skills/Capabilities (Future):** Initially, new minions will have default skills. Future enhancements could allow selecting specific skillsets or LLM configurations.
    *   **Resource Allocation (Future):** Not part of the initial design but a consideration for scaling.
*   **Registration with A2A Server:**
    *   Upon successful spawning, the new minion will initialize, create its `agent_card` (including the new `minion_id` and user-defined `minion_name`), and register with the A2A server via its [`a2a_client.py`](minion_core/a2a_client.py:105-158).
    *   The Management GUI will then discover the new minion through its regular polling of the A2A server's `/agents` endpoint.
*   **Role of `minion_spawner/spawn_legion.py`:**
    *   The current [`minion_spawner/spawn_legion.py`](minion_spawner/spawn_legion.py) is designed for initial batch spawning based on `config.toml`.
    *   **Proposal:**
        1.  The `minion_spawner` could be enhanced to run as a persistent service with an API (e.g., a simple HTTP endpoint) that the A2A server or Management GUI can call to request a new minion spawn.
        2.  Alternatively, the A2A server itself could take on the responsibility of invoking the spawning mechanism. This seems more aligned with the A2A server being the central hub.
        3.  For V1, the A2A server will expose a new endpoint (e.g., `/spawn-minion`). When the GUI calls this, the A2A server will execute a command similar to how [`spawn_legion.py`](minion_spawner/spawn_legion.py) works, but for a single, dynamically configured minion. This command will use the [`VENV_PYTHON_PATH`](minion_spawner/spawn_legion.py:21) and [`MINION_SCRIPT_PATH`](minion_spawner/spawn_legion.py:20) to launch a new [`main_minion.py`](minion_core/main_minion.py) process.
        4.  The parameters (newly generated `minion_id`, user-provided `minion_name`, personality) will be passed as command-line arguments to [`main_minion.py`](minion_core/main_minion.py).

## 3. Design the Interaction Flow

### 3.1. Naming (Initial)

1.  User (Steven) can optionally define a `name` in `config.toml` for minions spawned at startup.
2.  [`minion_spawner/spawn_legion.py`](minion_spawner/spawn_legion.py) reads this and passes it (or defaults to `id` if `name` is missing) to [`main_minion.py`](minion_core/main_minion.py).
3.  [`main_minion.py`](minion_core/main_minion.py) includes this `minion_name` in its `agent_card` when registering with the A2A server.
4.  GUI ([`management_gui/gui_app.py`](management_gui/gui_app.py)) fetches agent list and displays `minion_name` (and `minion_id`).

### 3.2. Renaming a Minion

1.  **GUI (Steven):**
    *   Steven views the list of minions in the Management GUI.
    *   He selects a minion and clicks "Rename".
    *   A dialog appears, pre-filled with the current `minion_name`. Steven enters a new name and clicks "Save".
2.  **GUI to A2A Server:**
    *   The GUI sends a request to the A2A server, e.g., `POST /agents/{minion_id}/rename` with payload `{"new_name": "NewMinionName"}`.
3.  **A2A Server Action:**
    *   The A2A server validates the request (e.g., checks for name conflicts if enforcing uniqueness).
    *   It updates its internal registry for the specified `minion_id` with the new `minion_name`. This includes updating the `name` field in the stored `agent_card`.
    *   The A2A server might also send a message to the specific minion informing it of its name change, though this is optional as the minion primarily operates on `minion_id`. For now, this direct notification to the minion is out of scope.
4.  **Confirmation:**
    *   A2A server responds to the GUI with success or failure.
    *   The GUI refreshes the minion list (or updates the specific minion's display) to show the new name.

### 3.3. Creating a New Minion

1.  **GUI (Steven):**
    *   Steven clicks "Create New Minion".
    *   A form appears requesting:
        *   `Minion Name` (text input)
        *   `Personality Traits` (text input or dropdown)
    *   Steven fills the form and clicks "Create".
2.  **GUI to A2A Server:**
    *   The GUI sends a request to the A2A server, e.g., `POST /spawn-minion` with payload `{"name": "UserDefinedName", "personality": "Traits..."}`.
3.  **A2A Server Action:**
    *   The A2A server receives the request.
    *   It generates a new unique `minion_id` (e.g., `uuid.uuid4().hex`).
    *   It constructs the command to launch a new minion process, similar to [`spawn_legion.py`](minion_spawner/spawn_legion.py:103-104) but for a single minion:
        ```bash
        /path/to/venv/bin/python /path/to/minion_core/main_minion.py --id <generated_uuid> --name "UserDefinedName" --personality "Traits..." --a2a-server <A2A_URL>
        ```
        *(Note: `--name` is a new argument to be added to `main_minion.py`)*
    *   The A2A server executes this command.
4.  **New Minion Initialization:**
    *   The new [`main_minion.py`](minion_core/main_minion.py) process starts.
    *   It uses the provided `minion_id`, `minion_name`, and `personality` to initialize itself.
    *   It registers with the A2A server using its [`a2a_client.py`](minion_core/a2a_client.py), providing its `agent_card` which includes the `minion_id` and `minion_name`.
5.  **Confirmation & Discovery:**
    *   The A2A server can respond to the GUI immediately after successfully *initiating* the spawn command.
    *   The Management GUI, through its regular polling of `/agents`, will discover the newly registered minion and display it. A success message like "Minion creation initiated. It will appear in the list shortly." can be shown.

## 4. Identify Codebase Impacts

### 4.1. Existing Files/Modules to Modify:

*   **`minion_core/main_minion.py`:**
    *   Modify `__init__` to accept a `minion_name` argument (e.g., `--name` via `argparse`).
    *   Store `minion_name` as an instance attribute.
    *   Update `agent_card` construction ([`main_minion.py:100-112`](minion_core/main_minion.py:100-112)) to include a distinct `user_facing_name` (or similar field) using this `minion_name`, in addition to the existing `name` field which might be a composite. The primary `id` field of the agent card remains `self.minion_id`.
        ```python
        # Example in main_minion.py
        self.minion_name = args.name if args.name else self.minion_id # Default name to ID if not provided
        # ...
        agent_card = {
            "id": self.minion_id,
            "user_facing_name": self.minion_name, # New field
            "name": f"Minion {self.minion_id} ({self.personality_traits.split(',')[0].strip()})", # Existing composite name
            # ... other fields
        }
        ```
*   **`minion_core/a2a_client.py`:**
    *   No direct changes required for renaming/creation logic itself, as it primarily deals with `minion_id`. However, ensure it correctly passes the enhanced `agent_card` (with `user_facing_name`) during registration.
*   **`minion_spawner/spawn_legion.py`:**
    *   Modify to read the optional `name` field from `config.toml` for each minion definition.
    *   Pass this `name` as the `--name` argument when calling `main_minion.py`. If `name` is not in config, it can pass the `id` as the `--name` or `main_minion.py` can default.
*   **`management_gui/gui_app.py`:**
    *   **Display:** Update `fetch_registered_minions` ([`gui_app.py:177`](management_gui/gui_app.py:177)) and `update_minion_display` ([`gui_app.py:394`](management_gui/gui_app.py:394)) to fetch and show the `user_facing_name` (and `minion_id` for clarity).
    *   **Rename UI:**
        *   Add UI elements (button, dialog, input field) for renaming.
        *   Implement function to call the A2A server's rename endpoint.
    *   **Create UI:**
        *   Add UI elements (button, form/dialog) for creating new minions.
        *   Implement function to call the A2A server's spawn endpoint.
    *   Ensure `get_sender_style` and chat display use `user_facing_name` if available, falling back to `minion_id`.
*   **A2A Server (Conceptual - not a specific file provided, but changes are needed):**
    *   **Agent Registry:** Modify to store and update `user_facing_name` for each agent, likely as part of or alongside the `agent_card`.
    *   **New Endpoints:**
        *   `POST /agents/{minion_id}/rename`: Accepts `{"new_name": "..."}`. Updates the name in the registry.
        *   `POST /spawn-minion`: Accepts `{"name": "...", "personality": "..."}`. Generates `minion_id`, triggers minion spawning process.
    *   The `/agents` endpoint should return the `user_facing_name` in the agent card data.

### 4.2. New Components or Configuration Settings:

*   **`config.toml`:**
    *   Optional `name` field within `[[minion_spawner.minions]]` tables.
*   **A2A Server:**
    *   Logic for handling the new rename and spawn endpoints.
    *   Mechanism to execute the `main_minion.py` script with appropriate arguments (this might involve `subprocess` calls similar to `spawn_legion.py`).
*   **`main_minion.py`:**
    *   New `--name` command-line argument.

### 4.3. Minion Identity (ID vs. Name):

*   **`minion_id`:**
    *   The **primary, immutable internal identifier**.
    *   Used for all system-level operations, A2A message routing, task assignment, logging internal references, and as the unique key in databases/registries.
    *   Can be pre-defined in `config.toml` (e.g., "Alpha") or auto-generated (UUID) for dynamically spawned minions.
*   **`minion_name` (user-facing name):**
    *   A **mutable, user-friendly alias**.
    *   Displayed in the GUI for easier identification by Steven.
    *   Stored by the A2A server and included in the `agent_card`.
    *   Should be distinct from `minion_id` in data structures to avoid confusion.
*   **Consistency:**
    *   The GUI will always display the `minion_id` alongside the `minion_name` in detailed views or tooltips to prevent ambiguity if names are not unique (though initial design aims for unique names).
    *   All backend operations (A2A server, minion internal logic) will continue to use `minion_id`.

### 4.4. Cross-Referencing Changes:

*   **Logging:** When logging, prefer `minion_id`. If `minion_name` is logged for context, ensure it's clear this is a mutable alias. Log name changes explicitly: "Minion [ID: xyz] renamed from 'OldName' to 'NewName'".
*   **Configuration:** The `minion_spawner` reads initial names from `config.toml`. Dynamic spawning uses GUI input.
*   **A2A Registration:** [`a2a_client.py`](minion_core/a2a_client.py) will send an `agent_card` containing both `id` and `user_facing_name` (and the composite `name`). The A2A server stores this.
*   **GUI Display:** The GUI fetches the list of agents from the A2A server and uses the `user_facing_name` for display.

## 5. Data Structures

### 5.1. A2A Server Agent Registry (Conceptual)

For each registered agent, the server might store (e.g., in memory, database):

```json
{
  "minion_uuid_1": { // Keyed by minion_id
    "minion_id": "minion_uuid_1", // Immutable
    "user_facing_name": "StrategistPrime", // Mutable
    "agent_card": { // The full agent card as provided by the minion
      "id": "minion_uuid_1",
      "name": "Minion minion_uuid_1 (Analytical)", // Composite name
      "user_facing_name": "StrategistPrime", // Mirrored here for completeness
      "description": "An AI Minion...",
      "personality_traits": "Analytical, Calm, Decisive",
      "capabilities": { "...": "..." },
      "skills": [ { "...": "..." } ],
      "url": "...",
      "version": "..."
    },
    "last_heartbeat": "timestamp",
    "status": "active" // etc.
  },
  "Alpha": {
    "minion_id": "Alpha",
    "user_facing_name": "AlphaCommander", // Initially "Alpha", then renamed
    "agent_card": {
        "id": "Alpha",
        "name": "Minion Alpha (Brave)",
        "user_facing_name": "AlphaCommander",
        // ...
    },
    // ...
  }
}
```

### 5.2. `config.toml` Minion Definition

```toml
[[minion_spawner.minions]]
id = "Alpha" # Immutable minion_id
name = "Alpha" # Optional: Initial user-facing name, defaults to id if missing
personality = "Brave, Loyal, Direct"
# other_params...

[[minion_spawner.minions]]
id = "minion_uuid_123"
name = "DataCruncher"
personality = "Meticulous, Inquisitive"
```

### 5.3. GUI State (`app_state["minions"]` in `gui_app.py`)

This will largely mirror the structure fetched from the A2A server's `/agents` endpoint, focusing on data needed for display.

```python
# app_state["minions"] in management_gui/gui_app.py
# Keyed by minion_id
app_state["minions"] = {
    "minion_uuid_1": {
        "id": "minion_uuid_1", # For internal GUI consistency
        "name_display": "StrategistPrime", # The user_facing_name to show
        "status": "Idle",
        "description": "...",
        "personality": "Analytical, Calm, Decisive", # Extracted or part of agent card
        # ... other relevant display data
    }
}
```
The `fetch_registered_minions` function in [`gui_app.py`](management_gui/gui_app.py:183) will need to be updated to populate `name_display` from the `user_facing_name` field of the agent card.

## 6. Edge Cases and Constraints

*   **Renaming to an Existing Name:**
    *   **A2A Server:** The rename endpoint should check if the proposed `new_name` is already in use by another minion (excluding the one being renamed).
    *   **Response:** If a conflict occurs, return an error (e.g., 409 Conflict) to the GUI.
    *   **GUI:** Display an error message to Steven.
    *   **Initial Policy:** Enforce unique `minion_name`s.
*   **Minion Offline During Rename Command:**
    *   The rename operation primarily affects the A2A server's registry and GUI display. The minion itself doesn't strictly need to be online to be renamed, as it operates on `minion_id`.
    *   The A2A server updates its record. When the minion next contacts the server (if ever for this info), it could theoretically sync, but this is not a V1 requirement.
*   **Resource Limitations for Creating New Minions:**
    *   The system (A2A server or machine running minions) has finite resources (CPU, memory).
    *   **Initial Design:** No explicit limit enforcement. Steven is responsible for not overwhelming the system.
    *   **Future:** The A2A server could monitor system resources or have a configured cap on the number of active minions. If limits are reached, the `/spawn-minion` endpoint would return an error.
*   **Failure to Spawn a New Minion:**
    *   If the A2A server fails to execute the spawn command (e.g., script not found, permissions issue), it should log the error and return an appropriate error code to the GUI.
    *   The GUI should inform Steven of the failure.
*   **Invalid Characters in Names:**
    *   The GUI and A2A server should sanitize/validate `minion_name` inputs to prevent issues (e.g., disallow overly long names, special characters that might break display or commands if names were ever used in paths/scripts - though they shouldn't be). A simple alphanumeric + spaces/hyphens policy is a good start.
*   **Case Sensitivity:**
    *   Decide on case sensitivity for `minion_name` uniqueness. Typically, case-insensitive checks are more user-friendly for aliases. `minion_id`s are often case-sensitive.

## 7. Consistency and Error Handling

*   **Centralized Naming Authority:** The A2A server is the authority for current `minion_name`s. The GUI always fetches from it.
*   **Error Messages:** Provide clear error messages in the GUI for failed operations (e.g., "Failed to rename minion: Name already exists," "Failed to create minion: Maximum capacity reached").
*   **Logging:** Robust logging on the A2A server, `minion_spawner` (if adapted), and individual minions is crucial for diagnostics. Log all management operations (create, rename attempts, success/failure).
*   **Transactional Operations (Future):** For more complex multi-step operations, consider transactional approaches, though this is likely overkill for V1 renaming/creation.

This design provides a solid foundation for minion management. The key is the clear distinction between the immutable `minion_id` and the mutable, user-facing `minion_name`, with the A2A server managing the mapping.
```